<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Z√§hler Dashboard Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg: #020617; --card: #1e293b; --text: #f8fafc; --muted: #94a3b8; --border: #334155;
            --p-strom: #3b82f6; --p-gas: #ef4444; --p-wasser: #0ea5e9; --p-pv: #f59e0b;
            --up: #ef4444; --down: #10b981;
            --input-text: #ffffff;
        }
        body.light-mode {
            --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #64748b; --border: #e2e8f0;
            --input-text: #0f172a;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; font-size: 13px; transition: 0.2s; overflow-x: hidden; }
        .container { max-width: 950px; margin: 0 auto; }
        
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--border); 
            gap: 10px;
        }

        /* Mobile Header Optimierung */
        @media (max-width: 600px) {
            header { flex-direction: column; text-align: center; }
            .header-left, .header-right { align-items: center; text-align: center; width: 100%; }
            .addr-text { align-items: center; margin-top: 5px; }
            .grid { grid-template-columns: 1fr; }
        }

        .header-left { flex: 1; display: flex; flex-direction: column; align-items: flex-start; }
        .header-center { flex: 1; display: flex; justify-content: center; }
        .header-right { flex: 1; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        
        .addr h2 { margin: 0; font-size: 18px; font-weight: 800; color: var(--text); }
        .addr-text { color: var(--muted); font-size: 11px; display: flex; flex-direction: column; line-height: 1.4; margin-top: 10px; }

        .logo-container { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .logo-img { max-height: 45px; width: auto; border-radius: 8px; }
        .logo-text { font-size: 12px; font-weight: 800; letter-spacing: 2px; margin-top: 5px; color: var(--text); text-transform: uppercase; }

        .grid { display: grid; grid-template-columns: 1fr 1.3fr; gap: 15px; margin-bottom: 20px; }
        
        .card { background: var(--card); padding: 15px; border-radius: 18px; border: 1px solid var(--border); box-sizing: border-box; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--input-text); font-size: 14px; margin-top: 4px; outline: none; box-sizing: border-box; -webkit-appearance: none; }
        
        .file-input-container { position: relative; margin-top: 4px; }
        #foto { opacity: 0; position: absolute; left: 0; top: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
        .file-label-custom { display: block; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); text-align: center; font-size: 13px; }

        label { font-size: 10px; font-weight: 800; color: var(--muted); text-transform: uppercase; display: block; margin-top: 10px; }
        .btn-save { background: var(--p-strom); color: white; width: 100%; padding: 14px; margin-top: 12px; font-size: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-item { padding: 12px; border-radius: 12px; background: var(--bg); border: 1px solid var(--border); text-align: center; }
        .stat-val { font-weight: 800; font-size: 16px; display: block; margin-top: 4px; }
        
        /* History Mobile View */
        .entry { background: var(--card); padding: 12px; border-radius: 15px; margin-bottom: 8px; display: flex; align-items: center; border: 1px solid var(--border); gap: 10px; }
        .entry-icon-wrap { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: rgba(128,128,128,0.1); flex-shrink: 0; }
        .entry-main { flex: 1; min-width: 0; }
        .entry-main b { font-size: 14px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .entry-right { display: flex; align-items: center; gap: 8px; }
        
        .img-preview { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
        .btn-action { padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; color: white; display: flex; align-items: center; justify-content: center; }
        .btn-edit { background: #64748b; }
        .btn-delete { background: #ef4444; }

        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; margin-bottom: 10px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .filter-btn { padding: 8px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--muted); white-space: nowrap; font-size: 12px; font-weight: 600; }
        .filter-btn.active { background: var(--p-strom); color: white; border-color: var(--p-strom); }

        .btn-lang { padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-weight: 700; cursor: pointer; }
        .btn-lang.active { background: var(--p-strom); color: white; }
    </style>
</head>
<body class="dark-mode">
<div class="container">
    <header>
        <div class="header-left">
            <div class="addr">
                <h2 id="l-dashboard">üìä Dashboard</h2>
                <div class="addr-text">
                    <span>üìç Beim Steinbrunnen 9</span>
                    <span>73340 Hofstett-Emerbuch / Amstetten</span>
                </div>
            </div>
        </div>
        <div class="header-center">
            <div class="logo-container">
                <img src="logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none';">
                <span class="logo-text">SimoxPalm</span>
            </div>
        </div>
        <div class="header-right">
            <div style="display:flex; gap:8px;">
                <button class="btn-lang" id="btn-de" onclick="setLang('DE')">DE</button>
                <button class="btn-lang" id="btn-it" onclick="setLang('IT')">IT</button>
            </div>
            <button class="btn-lang" style="font-size: 10px; margin-top:5px;" onclick="toggleLight()">üåì Mode</button>
        </div>
    </header>

    <div class="grid">
        <div class="card">
            <h3 id="l-newEntry">‚ú® Neuer Wert</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label id="l-typeLabel">Typ</label><select id="typ"></select></div>
                <div><label id="l-standLabel">Stand</label><input type="number" id="stand" step="0.01" placeholder="0,00"></div>
            </div>
            <label id="l-dateLabel">Datum</label>
            <input type="date" id="manuellesDatum">
            <label id="l-photoLabel">Foto</label>
            <div class="file-input-container">
                <input type="file" id="foto" accept="image/*" onchange="handleFileSelect(this)">
                <div class="file-label-custom" id="l-fileLabel">üì∏ Datei ausw√§hlen...</div>
            </div>
            <input type="hidden" id="editId">
            <button class="btn-save" onclick="saveData()" id="l-saveBtn">‚úÖ Speichern</button>
        </div>

        <div class="card">
            <h3 id="l-compareTitle">üìä Vergleich</h3>
            <div class="stats-grid" id="yearStats"></div>
            <div style="margin-top:20px; height: 180px;"><canvas id="myChart"></canvas></div>
        </div>
    </div>

    <div class="card">
        <div id="l-histTitle" style="font-weight:800; margin-bottom:12px; font-size:15px;">üìÇ History</div>
        <div id="typeFilters" class="filter-bar"></div>
        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
            <select id="yearSelect" onchange="setFilter('year', this.value)" style="flex: 2; margin-top:0;"></select>
            <button onclick="exportPDF()" style="flex:1; background:#ef4444; border:none; border-radius:8px; color:white; font-weight:700;">PDF</button>
            <button onclick="exportExcel()" style="flex:1; background:#10b981; border:none; border-radius:8px; color:white; font-weight:700;">XLS</button>
        </div>
        <div id="history"></div>
    </div>
</div>

<script>
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycby4Yl3Mvd_IjbZxzCrQHyqJS53tIz_d2HWriOx4Kg4EW1oT62xdRGRYaLcxOZPrqQtV/exec";
    let dataCache = [], filterType = "Alle", filterYear = "Alle", currentLang = "DE";

    const translations = {
        DE: { dashboard: "üìä Dashboard", newEntry: "‚ú® Neuer Wert", typeLabel: "Typ", standLabel: "Stand", dateLabel: "Datum", photoLabel: "Foto", saveBtn: "‚úÖ Speichern", updateBtn: "üîÑ Update", compareTitle: "üìä Vergleich", all: "Alle", allYears: "Alle Jahre", strom: "Strom", gas: "Gas", wasser: "Wasser", pv: "PV", histTitle: "üìÇ History", vs: "vs. 2024", fileSelect: "üì∏ Datei w√§hlen...", alertMiss: "Stand fehlt!", confirmDel: "L√∂schen?" },
        IT: { dashboard: "üìä Dashboard", newEntry: "‚ú® Nuovo valore", typeLabel: "Tipo", standLabel: "Lettura", dateLabel: "Data", photoLabel: "Foto", saveBtn: "‚úÖ Salva", updateBtn: "üîÑ Update", compareTitle: "üìä Confronto", all: "Tutti", allYears: "Tutti", strom: "Elettr.", gas: "Gas", wasser: "Acqua", pv: "PV", histTitle: "üìÇ Cronologia", vs: "vs. 2024", fileSelect: "üì∏ Scegli file...", alertMiss: "Manca lettura!", confirmDel: "Eliminare?" }
    };

    const iconMap = { "Strom": "‚ö°", "Gas": "üî•", "Wasser": "üíß", "Photovoltaik": "‚òÄÔ∏è" }, units = { "Strom": "kWh", "Gas": "m¬≥", "Wasser": "m¬≥", "Photovoltaik": "kWh" };

    function setLang(l) { currentLang = l; render(); }
    function toggleLight() { document.body.classList.toggle('light-mode'); }
    function setFilter(c, v) { if(c === 'type') filterType = v; else filterYear = v; render(); }
    function handleFileSelect(input) { document.getElementById('l-fileLabel').innerText = input.files.length > 0 ? input.files[0].name : translations[currentLang].fileSelect; }
    function formatDate(d) { return new Date(d).toLocaleDateString(currentLang === 'DE' ? 'de-DE' : 'it-IT'); }

    async function loadFromCloud() {
        try { const r = await fetch(CLOUD_URL); dataCache = await r.json(); dataCache.sort((a,b) => a.ts - b.ts); render(); } catch(e) { console.error(e); }
    }

    async function saveData() {
        const s = document.getElementById('stand').value, t = document.getElementById('typ').value, f = document.getElementById('foto').files[0], m = document.getElementById('manuellesDatum').value, eId = document.getElementById('editId').value;
        if(!s) return alert(translations[currentLang].alertMiss);
        let dObj = m ? new Date(m) : new Date();
        const img = f ? await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(f); }) : null;
        document.getElementById('l-saveBtn').innerText = "...";
        await fetch(CLOUD_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "save", id: eId ? parseInt(eId) : Date.now(), ts: dObj.getTime(), datum: dObj.toISOString(), typ: t, stand: parseFloat(s), jahr: dObj.getFullYear(), img: img }) });
        location.reload();
    }

    function render() {
        const t = translations[currentLang];
        document.getElementById('l-dashboard').innerText = t.dashboard;
        document.getElementById('l-newEntry').innerText = t.newEntry;
        document.getElementById('l-typeLabel').innerText = t.typeLabel;
        document.getElementById('l-standLabel').innerText = t.standLabel;
        document.getElementById('l-dateLabel').innerText = t.dateLabel;
        document.getElementById('l-photoLabel').innerText = t.photoLabel;
        document.getElementById('l-saveBtn').innerText = document.getElementById('editId').value ? t.updateBtn : t.saveBtn;
        document.getElementById('l-compareTitle').innerText = t.compareTitle;
        document.getElementById('l-histTitle').innerText = t.histTitle;
        
        document.getElementById('btn-de').classList.toggle('active', currentLang === 'DE');
        document.getElementById('btn-it').classList.toggle('active', currentLang === 'IT');

        document.getElementById('typ').innerHTML = `<option value="Strom">${iconMap.Strom} ${t.strom}</option><option value="Gas">${iconMap.Gas} ${t.gas}</option><option value="Wasser">${iconMap.Wasser} ${t.wasser}</option><option value="Photovoltaik">${iconMap.Photovoltaik} ${t.pv}</option>`;
        
        const filterBar = document.getElementById('typeFilters');
        filterBar.innerHTML = `<button class="filter-btn ${filterType === 'Alle' ? 'active' : ''}" onclick="setFilter('type', 'Alle')">${t.all}</button>` +
            ["Strom", "Gas", "Wasser", "Photovoltaik"].map(x => `<button class="filter-btn ${filterType === x ? 'active' : ''}" onclick="setFilter('type', '${x}')">${iconMap[x]}</button>`).join('');
        
        const years = [...new Set(dataCache.map(d => d.jahr))].sort((a,b) => b-a);
        const yS = document.getElementById('yearSelect'); yS.innerHTML = `<option value="Alle">${t.allYears}</option>`;
        years.forEach(y => { yS.innerHTML += `<option value="${y}" ${filterYear == y ? 'selected' : ''}>${y}</option>`; });

        const types = ["Strom", "Gas", "Wasser", "Photovoltaik"], curStands = [], barColors = [], chartLabels = [];
        let statsHtml = "";

        types.forEach(tk => {
            const lastEntry = dataCache.filter(d => d.typ === tk).pop();
            const s25 = lastEntry ? lastEntry.stand : 0;
            const cons = lastEntry && lastEntry.vergleich ? lastEntry.vergleich : 0;
            curStands.push(s25); barColors.push(cons > 0 ? '#ef4444' : '#10b981');
            chartLabels.push(iconMap[tk]);
            statsHtml += `<div class="stat-item"><span style="font-size:10px;">${iconMap[tk]}</span><span class="stat-val" style="color:${cons > 0 ? 'var(--up)' : 'var(--down)'}">${cons > 0 ? '+' : ''}${cons.toFixed(1)}</span></div>`;
        });
        document.getElementById('yearStats').innerHTML = statsHtml;

        const hist = document.getElementById('history'); hist.innerHTML = "";
        let fil = dataCache.filter(d => (filterType === "Alle" || d.typ === filterType) && (filterYear === "Alle" || d.jahr == filterYear));
        [...fil].reverse().forEach(e => {
            hist.innerHTML += `<div class="entry">
                <div class="entry-icon-wrap">${iconMap[e.typ]}</div>
                <div class="entry-main"><b>${e.stand} ${units[e.typ]}</b><small>${formatDate(e.datum)}</small></div>
                <div class="entry-right">
                    ${e.img ? `<img src="${e.img}" class="img-preview" onclick="window.open().document.write('<img src=${e.img} style=width:100%>')">` : ''}
                    <button class="btn-action btn-edit" onclick="editEntry(${e.id})">‚úèÔ∏è</button>
                    <button class="btn-action btn-delete" onclick="deleteEntry(${e.id})">üóëÔ∏è</button>
                </div>
            </div>`;
        });

        if(window.ch) window.ch.destroy();
        window.ch = new Chart(document.getElementById('myChart'), {
            type: 'bar', data: { labels: chartLabels, datasets: [{ data: curStands, backgroundColor: barColors }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function editEntry(id) {
        const item = dataCache.find(d => d.id == id);
        document.getElementById('editId').value = item.id;
        document.getElementById('stand').value = item.stand;
        document.getElementById('typ').value = item.typ;
        document.getElementById('manuellesDatum').value = new Date(item.ts).toISOString().split('T')[0];
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteEntry(id) {
        if(!confirm(translations[currentLang].confirmDel)) return;
        await fetch(CLOUD_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete", id: id }) });
        location.reload();
    }

    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Report", 14, 20);
        doc.autoTable({ head: [['Datum', 'Typ', 'Stand']], body: dataCache.map(e => [formatDate(e.datum), e.typ, e.stand]) });
        doc.save("Zaehler_Report.pdf");
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(dataCache);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Daten");
        XLSX.writeFile(wb, "Zaehler_Export.xlsx");
    }

    window.onload = loadFromCloud;
</script>
</body>
</html>
